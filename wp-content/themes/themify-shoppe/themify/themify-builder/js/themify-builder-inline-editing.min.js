'use strict';var TB_InlineEdit;
(function(g,A,r,G,n){var v,x,B=0,C,y,F,D,w=null,p,E,m,t,z,H=function(a){z&&D&&(a=a.closest(".module_row"),n.hasChanged=!0,n.undoManager.push(a.data("cid"),D,a,"row"),D=null)};TB_InlineEdit={is_editable:!1,is_active:!1,toolbar:null,tinymce:null,el:null,init:function(){Themify.LoadCss(g("#dashicons-css",top_iframe).prop("href"),!1);g(".themify_builder_content").on("click","[contenteditable]",this.enable);var a=g.ui.sortable.prototype._mouseDown,b=g(r);g.ui.sortable.prototype._mouseDown=function(c,e,
d){if(1===c.which)if(0<g(c.target).closest("[contenteditable]").length){var f=this;b.one("mousemove",function(b){1===b.which&&a.apply(f,[c,e,d])})}else a.apply(this,[c,e,d])};this.toolbar=g("#tb_editor");E=this.toolbar.on("click",".tb_editor_action",this._actionClicked).find("#tb_editor_link_edit");ThemifyBuilderCommon.Lightbox.$lightbox.on("themify_opened_lightbox",function(a){this.is_active&&(v=null,this.disable())}.bind(this))},activate:function(a){"false"!==a.prop("contenteditable")&&(a=a.find('[contenteditable="false"]').first());
0<a.length&&(y=!0,a.trigger("click"),y=!1,n.activeModel.unset("is_new",{silent:!0}),n.activeModel=null)},selectStart:function(a){"selectstart"===a.type?(v=!0,g(this).off("keyup",TB_InlineEdit._selection).on("keyup",TB_InlineEdit._selection)):1===a.which&&(v=!0,x=a.pageY,g(r).one("mouseup",function(a){x>a.pageY&&(x=a.pageY);TB_InlineEdit._selection()}))},enable:function(a){a.stopImmediatePropagation();a.preventDefault();v=null;!y&&n.activeModel&&n.Forms.saveComponent(a);var b=g(this),c=TB_InlineEdit,
e=b.closest(".active_module"),d=e.data("cid");if(d===F&&1===B)c.disable();else if("false"==this.contentEditable){B=0;z&&c.el&&(c.save(),H(c.el));c.el&&(c.el[0].contentEditable=!1,c.el.closest(".active_module").removeClass("tb_editor_on"));g("#tb_editor_carret").remove();D=ThemifyBuilderCommon.clone(e.closest(".module_row"));e[0].classList.add("tb_editor_on");c.is_editable=this.classList.contains("tb_editor_enable");if(c.is_editable&&"A"!==a.target.nodeName&&"button"!==a.target.nodeName&&0===g(a.target).closest("a").length){var f=
A.getSelection();if(0<f.rangeCount){var k=r.createElement("span");k.id="tb_editor_carret";f.getRangeAt(0).cloneRange().surroundContents(k)}}F=d;this.contentEditable=c.is_active=!0;c.is_editable||b.focus();z=!1;c.remove();var l=y;n.undoManager.disable();setTimeout(function(){if(c.is_active){B=0;c.el=b;m=b.closest(".themify_builder_slider");if(0<m.length){if(m.trigger("pause",!0),m.data("events").mousedown){t=m.data("events").mousedown;for(var d=0,q=t.length;d<q;++d)m.unbind("mousedown",t[d].handler)}}else m=
t=null;c.is_editable?(d=g.extend({},!0,tinyMCEPreInit.mceInit.tb_lb_hidden_editor),d.menubar=!1,d.inline=!0,d.skin=!1,d.target=b[0],d.theme=!1,d.plugins="lists",d.toolbar1=null,d.toolbar2=null,d.selector=!1,d.body_class=!1,d.content_css=null,d.external_plugins=null,d.wp_shortcut_labels=!1,d.branding=!1,d.auto_focus=!1,d.hidden_input=!1,d.setup=function(d){c.tinymce=d;d.on("init",function(){if(l){y=!1;var e=b.offset()}else if(k){e=d.dom.select("#tb_editor_carret")[0];d.selection.select(e,!0);if(A.getSelection&&
f.modify)f.collapseToStart(),f.modify("move","backward","word"),f.modify("extend","forward","word");else if((f=r.selection)&&"Control"!==f.type){var h=f.createRange();h.collapse(!0);h.expand("word")}e=g(e).offset();k=null}e&&(a.pageX=e.left,a.pageY=e.top);d.focus();c._setSelectedButtons();c._setCarret(a);b.on("mousedown selectstart",c.selectStart);d.on("Undo Redo",c._setSelectedButtons.bind(c))})},A.tinymce.init(d)):(c.toolbar.removeClass("tb_show").hide(),c.reset());b.one("keydown",function(){z=
!0});Themify.body[0].classList.add("tb_editor_active");g(r).off("click",c.disable).on("click",c.disable);"desktop"===n.activeBreakPoint&&n.Mixins.Builder.updateModuleSort(null,"disable")}else e.find(".themify_module_options").first().trigger("click")},y?1:250);++B}},remove:function(){this.save();n.undoManager.updateUndoBtns();if(this.tinymce){var a=this.tinymce.targetElm;tinymce.EditorManager.execCommand("mceRemoveEditor",!0,this.tinymce.id);a.setAttribute("contenteditable","false");this.tinymce.id===
g(a).off("mousedown selectstart",this.selectStart).off("keyup",this._selection).prop("id")&&a.removeAttribute("id");this.tinymce=null}},disable:function(a){if(!v){var b=TB_InlineEdit;if(!a||!b.toolbar[0].contains(a.target)){b.is_active=C=F=null;b.reset();B=0;Themify.body[0].classList.remove("tb_editor_active");g(".tb_editor_on").removeClass("tb_editor_on");b.toolbar.removeClass("tb_show").hide();b.remove();"desktop"===n.activeBreakPoint&&n.Mixins.Builder.updateModuleSort(null,"enable");g(r).off("click",
b.disable);g(".themify_builder_content").find('[contenteditable="true"]').prop("contenteditable","false");if(m&&"off"!==m.data("auto-scroll")){if(t){a=0;for(var c=t.length;a<c;++a)m.bind("mousedown",t[a].handler)}m.trigger("resume")}g("#tb_editor_carret").remove();H(b.el);b.el=D=m=t=x=null}}v=null},_setCarret:function(a){var b=TB_InlineEdit;!v&&a&&(x=a.pageY);var c=b.tinymce.selection?b.tinymce.selection.getRng().getBoundingClientRect():null;a=c?c.left+c.width/2:a.pageX;c=b.toolbar.height();var e=
b.toolbar.width(),d=g(A).width();a-=e/2;0>a?a=15:a+e>=d&&(a=d-1-e);c=x-c-40;0>c&&(c=15);b.toolbar.css({top:c,left:a});b.toolbar[0].classList.contains("tb_show")||b.toolbar.show()[0].classList.add("tb_show")},_selection:function(a){TB_InlineEdit._setSelectedButtons();TB_InlineEdit._setCarret(a)},_setSelectedButtons:function(){var a=!1;null===w&&(w=this.toolbar[0].getElementsByClassName("tb_editor_action"),p=[],a=!0);for(var b=0,c=w.length;b<c;++b){var e=w[b].dataset.action;if("top"!==e){var d=w[b].dataset.type,
f=g(w[b]),k=f.closest("li");d||(d=f.closest("ul").data("type"));k[0].classList.remove("tb_selected");this._actions[d].state?this._actions[d].state(e,f):this.state(d)&&k[0].classList.add("tb_selected")}else a&&p.push(w[b])}b=0;for(c=p.length;b<c;++b){a=p[b].getElementsByClassName("tb_selected");e=p[b].classList;d=0;for(f=e.length;d<f;++d)if(0===e[d].indexOf("ti-")){p[b].classList.remove(e[d]);break}if(0<a.length)for(e=a[0].classList,d=0,f=e.length;d<f;++d){if(0===e[d].indexOf("ti-")){var l=e[d];break}}else l=
p[b].dataset.default,g(p[b]).find(".tb_editor_selected_text").remove();l?p[b].classList.add(l):0<a.length&&(e=p[b].getElementsByClassName("tb_editor_selected_text"),a=a[0].getElementsByTagName("button")[0].dataset.action,0<e.length?e[0].innerHTML=a:p[b].insertAdjacentHTML("afterbegin",'<span class="tb_editor_selected_text">'+a+"</span>"))}},_actionClicked:function(a){a.preventDefault();a.stopImmediatePropagation();var b=TB_InlineEdit;if(0===g(this).closest(".tb_editor_active_tab").length){var c=g(this),
e=c.data("type"),d=c.data("action");if("top"===d){a=c.find("ul");var f=a.find(".tb_selected").next();if(0===f.length||f[0].classList.contains("ti-control-skip-forward")||f[0].classList.contains("ti-control-skip-backward"))f=a.find("li").first();f.find(".tb_editor_action").trigger("click")}else{e||(a=g(this).closest("ul"),e=a.data("type"));var k=b.toolbar.find("#tb_editor_"+e+"_wrapper"),l=function(){"expand"!==e&&(z=!0);C=e;b._actions[e].result(d,c,k);"expand"!==e&&(b._setSelectedButtons(),0<k.length&&
b._setCarret())};0<k.length?(b.reset(),b._setCarret(),b.toolbar.one("transitionend",function(){g(this).one("transitionend",function(){k[0].classList.add("tb_editor_active_tab");setTimeout(l,15)})[0].classList.add("tb_show");b._close()})[0].classList.remove("tb_show")):l()}}},reset:function(){var a=this.toolbar.find(".tb_editor_active_tab");0<a.length&&a[0].classList.remove("tb_editor_active_tab")},exec:function(a){var b=1<arguments.length&&arguments[1]!==G?arguments[1]:null;n.hasChanged=!0;(this.tinymce||
r).execCommand(a,!1,b)},state:function(a){a=this.tinymce.queryCommandState(a);return-1===a?!1:a},_close:function(){this.toolbar.one("click",".ti-close",function(a){a.preventDefault();a.stopPropagation();TB_InlineEdit.reset();TB_InlineEdit._actions.link.state();TB_InlineEdit._setCarret();C=!1})},_actions:{bold:{result:function(a,b){return TB_InlineEdit.exec("bold")}},text_align:{result:function(a,b){return TB_InlineEdit.exec(a)},state:function(a,b){TB_InlineEdit.state(a)&&b.closest("li")[0].classList.add("tb_selected")}},
underline:{result:function(a,b){return TB_InlineEdit.exec("underline")}},paragraph:{result:function(a,b){return TB_InlineEdit.exec("formatBlock",a)},state:function(a,b){0<g(A.getSelection().focusNode).closest(a).length&&b.closest("li")[0].classList.add("tb_selected")}},list:{result:function(a,b){return TB_InlineEdit.exec(a)},state:function(a,b){"Indent"!==a&&"Outdent"!==a&&!0===TB_InlineEdit.state(a)&&b.closest("li")[0].classList.add("tb_selected")}},italic:{result:function(a,b){return TB_InlineEdit.exec("italic")}},
link:{loaded:null,result:function(a,b,c){var e=TB_InlineEdit,d=this;a=e.toolbar;var f=c.find(".ti-angle-double-up"),k=f.next(".tb_editor_link_options").hide(),l=k.find("#tb_editor_link_type"),h=c.find(".tb_link_input"),q=function(a){if("keydown"!==a.type||13===a.which)if(a.preventDefault(),a.stopImmediatePropagation(),a=g.trim(h.val())){h.off("keydown",q);a={href:a};if(f.hasClass("ti-angle-double-down")){var b=l.val();if("lightbox"===b){var c=k.find("#tb_editor_lightbox_w"),u=k.find("#tb_editor_lightbox_h");
if(0<c.val()||0<u.val()){if(0<c.val()){var m=c.next().find("select").val();a["data-w"]=+c.val()+("px"===m?"":m)}0<u.val()&&(m=u.next().find("select").val(),a["data-h"]=+u.val()+("px"===m?"":m))}}}"blank"===b?a.target="_blank":"lightbox"===b&&(a.class="themify_lightbox");e.exec("mceInsertLink",a);e.reset();d.state();n.hasChanged=!0;h.val("");e._setCarret()}};h.off("keydown",q).on("keydown",q);f.off("click").on("click",function(a){a.preventDefault();a.stopPropagation();k.one("transitionend",function(){e._setCarret()});
g(this).toggleClass("ti-angle-double-down")});a.one("click",".ti-check",q);var u=k.find(".tb_editor_lightbox_actions").css("display","");l.off("change").on("change",function(a){u.one("transitionend",function(){e._setCarret()}).css("display","").toggleClass("tb_editor_lightbox_actions_open","lightbox"===g(this).val());e._setCarret()});if(h.val()){if(c=g(e.tinymce.selection.getNode()).closest("a"),0<c.length){var m=c[0].classList.contains("themify_lightbox");var p=!m&&"_blank"===c.prop("target");c=
null}}else l.val("");m||p?(u.addClass("tb_editor_lightbox_actions_open"),f.addClass("ti-angle-double-down")):(u.removeClass("tb_editor_lightbox_actions_open"),f.removeClass("ti-angle-double-down"));k.css("display","");e._setCarret();h.focus()},state:function(a,b){var c=TB_InlineEdit,e="";a=c.tinymce.selection.getNode();"A"===a.nodeName&&(e=a.getAttribute("href"),c.toolbar.find("#tb_editor_link_wrapper")[0].classList.contains("tb_editor_active_tab")||(E.addClass("tb_editor_active_tab").find("a").prop("href",
e),E.one("click",".ti-unlink",function(a){a.preventDefault();a.stopImmediatePropagation();c.exec("unlink");c.reset()}).find(".tb_editor_link_value button").text(e).one("click",function(a){a.preventDefault();a.stopImmediatePropagation();c.toolbar.find(".tb_link_input").val(e);c.reset();g(".tb_editor_action",g(".tb_editor_link",c.toolbar)).trigger("click")})));c.toolbar.find(".tb_link_input").val(e);b=c.toolbar.find("#tb_editor_link_type");var d="",f=c.toolbar.find(".tb_editor_lightbox_actions");if(""!==
e){a.classList.contains("themify_lightbox")?(d="lightbox",f.show()):"_blank"===a.target&&(d="blank");if("lightbox"!==d)c.toolbar.find("#tb_editor_lightbox_w,#tb_editor_lightbox_h").val(""),f.hide();else{f=["w","h"];for(var k=0;2>k;++k){var l=a.dataset[f[k]],h=g("#tb_editor_lightbox_"+f[k]+"_unit");if(l){var q=parseFloat(l);if(!q||0>q)q="";h.val(-1!==l.indexOf("%")?"%":"");c.toolbar.find("#tb_editor_lightbox_"+f[k]).val(q)}else h.val("")}}b.val(d)}else E.hasClass("tb_editor_active_tab")&&(E.removeClass("tb_editor_active_tab"),
c.toolbar.find("#tb_editor_lightbox_w,#tb_editor_lightbox_h").val(""));return""!==e}},color:{input:null,is_trigger:!1,result:function(a,b,c){var e=TB_InlineEdit;if(!this.input){a=g('link[href*="jquery.minicolors.css"]',top_iframe).prop("href");Themify.LoadCss(a,!1);n.Utils.setColorPicker(c);this.input=c.find(".minicolors-input");var d=this.input.prop("id"),f=this,k=!1;Themify.body.on("themify_builder_color_picker_change",function(a,b,c,g){d!==b||""===g||f.is_trigger||(e.exec("foreColor",g),n.hasChanged=
!0,k&&(k=!1,this.input.focus()));f.is_trigger=!1});this.input.on("mousedown",function(a){k=!0}).next(".minicolors-swatch").trigger("click")}},state:function(){if("color"===C&&this.input){var a=TB_InlineEdit.tinymce.queryCommandValue("foreColor");""!==a&&!1!==a&&(this.is_trigger=!0,this.input.minicolors("value",a))}}},fonts:{loaded:null,getValue:function(a,b,c){for(;b.parentNode.id!==TB_InlineEdit.tinymce.id;){if(b.style[a])return c&&(b.style[a]=""),b.style[a];b=b.parentNode}return!1},result:function(a,
b,c){if(!this.loaded){var e=TB_InlineEdit,d=!1;themifyBuilder.fonts?(a=themifyBuilder.fonts.safe,b=themifyBuilder.fonts.google,d=!0):(a=ThemifyBuilderCommon.safe_fonts,b=ThemifyBuilderCommon.google_fonts);this.loaded=c;var f=c.find("#tb_editor_font_select optgroup");c=c.find(".tb_range");var k=this,l="",h;for(h in a)if(!d||1<h)l+='<option value="'+(d?a[h].value:h).replace(/'/g,"")+'">'+(d?a[h].name:a[h])+"</option>";f[0].innerHTML=l;l="";for(h in b)if(!d||1<h)l+='<option value="'+(d?b[h].value:h)+
'">'+(d?b[h].name:b[h])+"</option>";f.last()[0].innerHTML=l;f.first().closest("select").change(function(a){a=g.trim(g(this).val());"google"===g(this).find('[value="'+a+'"]').closest("optgroup").data("type")&&ThemifyBuilderCommon.loadGoogleFonts(a);e.exec("fontName",a)});c.each(function(){var a=g(this).next().find(".tb_unit")[0],b=g(this).prop("id"),c="tb_editor_font_size"===b,d=!1,f="tb_editor_line_height"===b?"line-height":"letter-spacing",h;g(this).keyup(function(l){var m=this;h&&clearTimeout(h);
h=setTimeout(function(){var h=m.value;if(""!==h)if(h+=a.value,c)e.exec("fontSize",h);else{var l={};l[f]=h;tinymce.activeEditor.formatter.register(b,{inline:"span",styles:l});e.tinymce.formatter.apply(b)}else k.getValue(c?"fontSize":"tb_editor_line_height"===b?"lineHeight":"letterSpacing",e.tinymce.selection.getNode(),!0);d&&(d=!1,g(m).focus())},8)}).focus(function(){d=!0});n.Utils.createRange(g(this),r)})}},state:function(){if(this.loaded&&"fonts"===C){var a=TB_InlineEdit,b=a.tinymce.queryCommandValue("fontName"),
c=a.toolbar.find("#tb_editor_font_select");if(b){var e=c[0].getElementsByTagName("option"),d=!1;b=b.replace(/"/g,"");for(var f=0,k=e.length;f<k;++f)if(e[f].value===b){d=e[f].selected=!0;break}d||(b=!1,c.val(""))}else c.val("");var l=this,h=a.tinymce.selection.getNode();this.loaded.find(".tb_range").each(function(){var b=this.id,c=l.getValue("tb_editor_font_size"===b?"fontSize":"tb_editor_line_height"===b?"lineHeight":"letterSpacing",h),d="px";!1===c?c="":(d=-1!==c.indexOf("em")?"em":-1!==c.indexOf("%")?
"%":"px",c=parseFloat(c));a.toolbar.find("#"+b+"_unit").val(d);g(this).val(c)});return b}}},expand:{result:function(a,b,c){TB_InlineEdit.save();TB_InlineEdit.disable();TB_InlineEdit.el.closest(".active_module").find(".themify_module_options").first().trigger("click")}}},save:function(){if(z&&this.el){g("#tb_editor_carret").remove();var a=this.el.closest(".active_module").data("cid"),b=this.tinymce?this.tinymce.getContent():this.el[0].innerText,c=n.Models.Registry.lookup(a),e=this.el.data("name"),
d=this.el.data("repeat");c&&e&&(c=c.get("mod_settings"),d!==G?c[d]&&(c[d][this.el.data("index")][e]=b):c[e]=b,n.Models.setValue(a,c,!0))}}}})(jQuery,window,document,tb_app);
